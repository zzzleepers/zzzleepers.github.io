<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>博客目录 - 沐泽</title>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <link rel="icon" href="https://avatars.githubusercontent.com/u/132760387?v=4&size=16" type="image/x-icon">
    <link rel="stylesheet" href="https://zzzleepers.github.io/blog-style.css">
    <script>
        // GitHub仓库配置
        const GITHUB_CONFIG = {
            owner: "zzzleepers",
            repo: "zzzleepers.github.io",
            baseDir: "blog/"
        };

        let currentPath = "";
        const dirCache = new Map();

        document.addEventListener('DOMContentLoaded', async () => {
            await renderBlogList();
        });

        async function fetchGithubFiles(path = "") {
            if (dirCache.has(path)) {
                return dirCache.get(path);
            }

            try {
                const apiUrl = `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.baseDir}${path}`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`获取目录失败（${response.status}）`);
                }

                const rawData = await response.json();
                const formattedData = rawData
                    .filter(item => {
                        return (item.type === "file" && item.name.endsWith(".html")) || 
                               (item.type === "dir" && !item.name.startsWith("."));
                    })
                    .map(item => {
                        // 处理文件信息，提取日期和标题
                        let date = null;
                        let title = item.name;
                        
                        if (item.type === "file") {
                            // 移除.html后缀
                            const nameWithoutExt = item.name.replace(".html", "");
                            
                            // 匹配[YYYY-MM-DD]格式的日期
                            const dateMatch = nameWithoutExt.match(/^\[(\d{4}-\d{2}-\d{2})\](.*)$/);
                            
                            if (dateMatch) {
                                date = dateMatch[1];
                                // 提取标题并去除可能的空格
                                title = dateMatch[2].trim();
                            }
                        }
                        
                        return {
                            originalName: item.name,
                            name: title || item.name, // 如果没有匹配到日期，使用原始名称
                            path: item.path.replace(GITHUB_CONFIG.baseDir, ""),
                            fullPath: item.path,
                            type: item.type,
                            date: date, // 从文件名提取的日期
                            updated: new Date(item.updated_at).getTime(),
                            updatedAt: item.updated_at
                        };
                    });

                dirCache.set(path, formattedData);
                return formattedData;
            } catch (error) {
                console.error("GitHub API 请求错误：", error);
                return [{
                    name: "目录加载失败",
                    path: "",
                    type: "file",
                    date: null,
                    updated: new Date().getTime(),
                    updatedAt: new Date().toISOString()
                }];
            }
        }

        async function renderBlogList() {
            const fileList = await fetchGithubFiles(currentPath);
            
            // 排序逻辑：
            // 1. 文件夹排在前面
            // 2. 文件按提取的日期排序（最新的在前）
            // 3. 没有日期的文件按更新时间排序
            const sortedList = [...fileList].sort((a, b) => {
                // 文件夹排在文件前面
                if (a.type !== b.type) {
                    return a.type === "dir" ? -1 : 1;
                }
                
                // 都是文件夹，按名称排序
                if (a.type === "dir" && b.type === "dir") {
                    return a.name.localeCompare(b.name);
                }
                
                // 都是文件，按日期排序
                if (a.date && b.date) {
                    // 日期字符串可以直接比较，因为是YYYY-MM-DD格式
                    return b.date.localeCompare(a.date);
                }
                
                // 一个有日期，一个没有日期，有日期的排在前面
                if (a.date) return -1;
                if (b.date) return 1;
                
                // 都没有日期，按更新时间排序
                return b.updated - a.updated;
            });

            const blogListEl = document.getElementById("blog-list");
            const pathDisplayEl = document.getElementById("current-path");
            const totalCountEl = document.getElementById("total-count");

            blogListEl.innerHTML = "";

            pathDisplayEl.textContent = currentPath 
                ? `当前目录：/blog/${currentPath}` 
                : "博客根目录";

            totalCountEl.textContent = fileList.length;

            if (currentPath) {
                const backItem = document.createElement("div");
                backItem.className = "blog-item";
                backItem.innerHTML = `
                    <a href="#" class="blog-link">
                        <i class="fa fa-level-up mr-2"></i>
                        <span>../ 返回上级目录</span>
                        <span class="updated-time">${formatDate(new Date())}</span>
                    </a>
                `;
                backItem.addEventListener("click", (e) => {
                    e.preventDefault();
                    const pathParts = currentPath.split("/").filter(Boolean);
                    pathParts.pop();
                    currentPath = pathParts.join("/") || "";
                    renderBlogList();
                });
                blogListEl.appendChild(backItem);
            }

            sortedList.forEach(item => {
                const itemEl = document.createElement("div");
                itemEl.className = "blog-item";

                const iconClass = item.type === "dir" ? "fa-folder" : "fa-file-text-o";
                // 使用绝对路径确保链接正确
                const itemLink = item.type === "dir" 
                    ? "#" 
                    : `/blog/${item.path}`;

                // 显示从文件名提取的日期，如果没有则显示更新时间
                const displayDate = item.date || formatDate(new Date(item.updated));

                itemEl.innerHTML = `
                    <a href="${itemLink}" class="blog-link">
                        <i class="fa ${iconClass} mr-2"></i>
                        <span class="blog-title">${item.name}${item.type === "dir" ? "/" : ""}</span>
                        <span class="updated-time">${displayDate}</span>
                    </a>
                `;

                if (item.type === "dir") {
                    itemEl.addEventListener("click", (e) => {
                        e.preventDefault();
                        currentPath = item.path;
                        renderBlogList();
                    });
                }

                blogListEl.appendChild(itemEl);
            });
        }

        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, "0");
            const day = String(date.getDate()).padStart(2, "0");
            return `${year}-${month}-${day}`;
        }
    </script>
    <style>
        /* 保留内嵌样式作为备份，确保在CSS加载失败时仍有基础样式 */
        .blog-header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .blog-header h1 {
            font-size: 2rem;
            margin-bottom: 0.8rem;
            border-bottom: none;
        }

        .path-display {
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1.2rem;
            font-style: italic;
            font-size: 0.95rem;
        }

        .directory-info {
            margin: 1rem 0 1.5rem;
            padding: 0.8rem 1rem;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .blog-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
        }

        .blog-item {
            padding: 0.8rem 1rem;
            border-radius: 6px;
            transition: background-color 0.25s ease;
        }

        .blog-item:hover {
            background-color: rgba(255, 255, 255, 0.08);
        }

        .blog-link {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            color: white !important;
            text-decoration: none !important;
        }

        .blog-title {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .updated-time {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.85rem;
            white-space: nowrap;
            margin-left: 1rem;
            min-width: 90px;
            text-align: right;
        }

        @media (max-width: 640px) {
            .blog-link {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.3rem;
            }

            .updated-time {
                margin-left: 0;
                margin-top: 0.2rem;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="glass">
            <div class="nav-container">
                <!-- 使用绝对路径指向首页 -->
                <a href="/index.html" class="site-title">
                    <i class="fa fa-home mr-2"></i>zzzleeper
                </a>
                <div class="nav-links">
                    <a href="https://zzzleepers.github.io/index.html"><i class="fa fa-home"></i> 首页</a>
                    <a href="https://zzzleepers.github.io/blog.html" class="text-accent"><i class="fa fa-book"></i> 博客目录</a>
                    <a href="https://zzzleepers.github.io/contact.html"><i class="fa fa-envelope"></i> 联系</a>
                    <a href="https://zzzleepers.github.io/links.html"><i class="fa fa-link"></i> 链接</a>
                </div>
            </div>
        </nav>

        <main class="glass">
            <div class="blog-header">
                <h1>博客目录</h1>
                <div class="directory-info">
                    共 <span id="total-count">0</span> 个文件/文件夹 · 按日期排序（最新靠前）
                </div>
                <div class="path-display" id="current-path">博客根目录</div>
            </div>

            <div class="blog-list" id="blog-list"></div>
        </main>

        <footer class="glass">
            <div class="mb-2">
                <a href="https://icp.gov.moe/?keyword=20254447" target="_blank" class="icp-link">
                    <img src="https://icp.gov.moe/images/ico64.png" alt="萌ICP备案标识" style="width: 16px; height: 16px;">
                    萌ICP备20254447号
                </a>
            </div>
            <div class="mb-2">
                <a href="https://travel.moe/go.html" title="异次元之旅-跃迁-我们一起去萌站成员的星球旅行吧！" target="_blank" class="travel-link">
                    <img src="https://travel.moe/images/icon/icon64pink.png" style="width:20px;height:20px;margin-right:4px;">异次元之旅🚀
                </a>
            </div>
            <div>© 2025 zzzleepers | <a href="https://zzzleepers.github.io/index.html">回到首页</a></div>
        </footer>
    </div>
</body>
</html>
